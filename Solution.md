ðŸŸ¢.Q.1. Top Selling Products Query the top 10 products by total sales value.
Challenge: Include product name, total quantity sold, and total sales value.

### Solutions Implemented:
```sql
select p.product_name, 
sum(o.quantity) as total_quantity,
round(sum(o.price_per_unit * o.quantity),2) as total_value  
from order_items o
join products p on o.product_id = p.product_id 
group by product_name 
order by total_value desc limit 10;
```
---
![image](https://github.com/user-attachments/assets/3fe6ac44-74f0-4d56-9cb2-ccd3065b2971)

---

ðŸŸ¢.Q.2. Revenue by Category Calculate total revenue generated by each product category.
 Challenge: Include the percentage contribution of each category to total revenue.

### Solutions Implemented:
```sql
with total_revenue_by_category as (
select products.category_id,category.category_name,sum(order_items.quantity*order_items.price_per_unit) as total_revenue_per_category from products
join order_items on order_items.product_id = products.product_id 
join category on category.category_id = products.category_id
group by products.category_id,category.category_name
)
select *,
round((total_revenue_per_category / 
(sum(total_revenue_per_category) over())*100),2) 
as Contribution_by_Category
from total_revenue_by_category ;
```
---
![image](https://github.com/user-attachments/assets/528158c1-043b-4224-9d26-8dc5f08f18e3)

---

ðŸŸ¢.Q.3. Average Order Value (AOV) Compute the average order value for each customer.
Challenge: Include only customers with more than 5 orders.
Total Revenue = Qty * price item.
AOV= TotalÂ Revenue/TotalÂ NumberÂ ofÂ Orders 
â€‹
### Solutions Implemented:
```sql

select customers.customer_id,
    round(sum(order_items.quantity*order_items.price_per_unit)/count(order_items.order_id),2) as total from orders
    join order_items on order_items.order_id = orders.order_id
    join customers on customers.customer_id = orders.customer_id
    group by orders.customer_id
    having(count(order_items.order_id)>5)
    order by customer_id
```
---
![image](https://github.com/user-attachments/assets/76bbc2c9-74a9-42cb-b287-b622e1179307)

---
ðŸŸ¢.Q.4. Monthly Sales Trend :- Query monthly total sales over the past year.
Challenge: Display the sales trend, grouping by month, return current_month sale, last month sale!

### Solutions Implemented:
```sql

select
    month(ord.order_date) as month,
    year(ord.order_date) as year,
    round(sum(ord_itm.quantity * ord_itm.price_per_unit), 2) as monthly_total_sales,
    lag(round(sum(ord_itm.quantity * ord_itm.price_per_unit), 2), 1, 0)
        over (order by year(ord.order_date), month(ord.order_date)) as prv_month
from
    order_items as ord_itm
    join orders ord using(order_id)
where
    ord.order_date between '2023-07-30' and '2024-07-30'
group by
    year(ord.order_date), month(ord.order_date);


```
---
![image](https://github.com/user-attachments/assets/84284ee9-f68a-4054-893a-bfaeb5d1086e)

---

ðŸŸ¢.Q.5. Customers with No Purchases Find customers who have registered but never placed an order.
Challenge: List customer details and the time since their registration.

### Solutions Implemented:
```sql
select * from
customers where customer_id not in (
select customer_id from
orders as ord_itm
)
```
---
![image](https://github.com/user-attachments/assets/ba8805f8-391f-4b15-b7d8-f6a61e7dfe12)

---

ðŸŸ¢.Q.6.Least-Selling Categories by State
Identify the least-selling product category for each state.
Challenge: Include the total sales for that category within each state.

### Solutions Implemented:
```sql
with cte as (
select 
c.category_name,cust.state,
round(sum(ord_itm.quantity*ord_itm.price_per_unit),2) as total_sales,
dense_rank() over(partition by cust.state order by sum(ord_itm.quantity*ord_itm.price_per_unit)) as rnk
from order_items as ord_itm
join orders as ords
using(order_id)
join customers as cust
using(customer_id)
join products as p
using(product_id)
join category as c
using(category_id)
group by 1,2
)
select state as state,category_name as least_seiing_category,total_sales
from cte where rnk <= 1
```
---
![image](https://github.com/user-attachments/assets/8f73774d-3da3-4c04-9ddd-88ecdfa63ddc)

---

ðŸŸ¢.Q.7. Customer Lifetime Value (CLTV)
Calculate the total value of orders placed by each customer over their lifetime.
Challenge: Rank customers based on their CLTV.
### Solutions Implemented:
```sql
select c.first_name,c.last_name,
round(sum(ord_itm.quantity*ord_itm.price_per_unit),2) as total_order_value,
dense_rank() over w as rnk
from order_items as ord_itm
join orders as ord
using(order_id)
left join customers as c
using(customer_id)
group by c.first_name,c.last_name
window w as (order by round(sum(ord_itm.quantity*ord_itm.price_per_unit),2) desc)

```
---
![image](https://github.com/user-attachments/assets/749d0635-057b-47e8-8a98-4b577198b8d4)

---

ðŸŸ¢.Q.8. Inventory Stock Alerts
Query products with stock levels below a certain threshold (e.g., less than 10 units).
Challenge: Include last restock date and warehouse information.

### Solutions Implemented:
``` SQL
SELECT inv.product_id,inv.stock,inv.warehouse_id,inv.last_stock_date,
p.product_name 
FROM amazon_analysis.inventory inv
join products as p
using(product_id)
where stock < 10;
```
---
![image](https://github.com/user-attachments/assets/72501b5e-edb4-489e-96ca-a39fc13196d2)
---
ðŸŸ¢.Q.9. Shipping Delays
Identify orders where the shipping date is later than 3 days after the order date.
Challenge:customer_id,product_id,order_Date,shipping_date,delays_in_days,product_name,delivery_status

### Solutions Implemented:
``` SQL
with cte as (
SELECT ord.customer_id,ord_itm.product_id,p.product_name,
ord_itm.order_id,ord.order_date,
ship.shipping_date,
datediff(ship.shipping_date,ord.order_date) as shipping_delays,
ship.delivery_status
FROM amazon_analysis.order_items as ord_itm
join orders as ord
using(order_id)
join products as p
using(product_id)
join shippings as ship
using(order_id)
)

select * from cte where shipping_delays > 3
```
---
![image](https://github.com/user-attachments/assets/92fb49ab-ec35-4439-95db-996950191cc8)
---
ðŸŸ¢.Q.10. Payment Success Rate 
Calculate the percentage of successful payments across all orders.
Challenge: Include breakdowns by payment status (e.g., failed, pending).
### Solutions Implemented:
``` SQL
select payment_status ,count(payment_id) as payments_status_count,
sum(count(payment_id))over() as total_paymanets,
round((count(payment_id) /sum(count(payment_id))over())*100,2) as payment_status_contribution
from payments
group by payment_status

```
---
![image](https://github.com/user-attachments/assets/20fbf839-5df8-4948-b5c7-caeded0a9a64)

---
ðŸŸ¢.Q.11. Top Performing Sellers
Find the top 5 sellers based on total sales value.
Challenge: Include both successful and failed orders, and display their percentage of successful orders.
### Solutions Implemented:
``` SQL
with sell as (
select s.seller_id,round(sum(ord_itm.quantity*ord_itm.price_per_unit),2) as total_sales_by_seller,
count(case when order_status = "Cancelled" then 1 else null end) as cancelled_orders_count,
count(case when order_status = "Completed" then 1 else null end) as Completed_orders_count,
count(ord_itm.order_id) as total_orders_count 
from order_items as ord_itm
join orders as ord 
using(order_id)
join sellers as s
using(seller_id)
group by s.seller_id
order by s.seller_id , total_sales_by_seller desc limit 5
)
select *,
round((Completed_orders_count/total_orders_count)*100,2) as successful_orders_contribution
from sell

```
---
![image](https://github.com/user-attachments/assets/2c8efd00-cdd1-4286-9a22-8c87a4658c74)
---

ðŸŸ¢.Q.12. Product Profit Margin
Calculate the total profit margin for each product (difference between price and cost of goods sold).
Challenge: Rank products by their profit margin,total_sales,_total_cogs,profit_margin_%, showing highest to lowest.
### Solutions Implemented:
``` SQL
/*
12. Product Profit Margin
Calculate the profit margin for each ordered product (difference between price and cost of goods sold).
Challenge: Rank products by their profit margin, showing highest to lowest.
*/
with cte as (
select ord_itm.product_id,p.product_name,
round((ord_itm.quantity * ord_itm.price_per_unit),2) as total_sales,
round((ord_itm.quantity * p.cogs),2) as total_cogs
from order_items as ord_itm
join products as p
using(product_id)
-- where ord_itm.product_id = 2
),
PandL_values as (
select product_id,product_name,
round(sum(total_sales),2) as total_sales,
round(sum(total_cogs),2) as total_cogs,
round((sum(total_sales) - sum(total_cogs)),2) as total_profit_margin,
round(((sum(total_sales) - sum(total_cogs)) 
/sum(total_sales))*100,2) as profit_margin_percent
from cte 
group by 1,2
)
select *,dense_rank()over(order by profit_margin_percent desc) as rnk from PandL_values
```
---
![image](https://github.com/user-attachments/assets/7f42f734-abd1-4e62-9f04-bc341abd7022)
---

ðŸŸ¢.Q.13.Most Returned Products
Query the top 10 products by the number of returns.
Challenge: Display the return rate as a percentage of total units sold for each product.
### Solutions Implemented:
``` SQL
with cte as
(
select ord_itm.product_id,p.product_name,
sum(ord_itm.quantity) as total_order_qunatity,
sum(case when ord.order_status = "Returned" then ord_itm.quantity else null end) as total_return_prd_cnt
from order_items as ord_itm
join orders as ord
using(order_id)
join products as p
using(product_id)
group by 1,2
order by total_return_prd_cnt desc
limit 10
)
select *,
round((total_return_prd_cnt/total_order_qunatity)*100,2) as return_rate
from cte
```
---
![image](https://github.com/user-attachments/assets/d90d54c2-d08f-4792-a648-f8e80eb581a9)
---
ðŸŸ¢.Q.14.Orders Pending Shipment
Find orders that have been paid but are still pending shipment.
Challenge: Include order details, payment date, and customer information.
### Solutions Implemented:
```sql
select * from orders as
ord
join customers as cust
using(customer_id)
join payments as pymnt
using(order_id)
where pymnt.payment_status = "Payment Successed"
	and ord.order_status = "Inprogress"
```
---
![image](https://github.com/user-attachments/assets/e02eca95-1f1e-4ce8-9b13-12734cb6f8e3)
---
ðŸŸ¢.Q.15. Inactive Sellers
Identify sellers who havenâ€™t made any sales in the last 6 months.
Challenge: Show the last sale date and total sales from those sellers
```sql
with no_sales_seller_ids as(
select seller_id from sellers
where seller_id not in (
select seller_id from orders as ord
where order_date >= date_add(current_date(),interval -6 month)
))
select ord.seller_id,
round(sum(ord_itm.quantity*ord_itm.price_per_unit),2)as total_sales
,max(order_date) as last_sales_date
from orders as ord
join order_items as ord_itm
using(order_id)
where ord.seller_id in (select seller_id from no_sales_seller_ids)
group by ord.seller_id

```
---
ðŸŸ¢.Q.16. IDENTITY customers into returning or new
if the customer has done more than 5 return (based on order cnt not unit) categorize them as returning otherwise new
Challenge: List customers id, name, total orders, total returns
```sql
with cte as ( 
select cust.customer_id,
concat_ws(" ",cust.first_name,cust.last_name) as name,
count(ord.order_id) as total_orders,
sum(case when ord.order_status="Returned" then 1 else 0 end) as total_returns
-- sum(case when ord.order_status = "%Returned%" then 1 else 0 end) as total_returns 
from orders as ord
join customers as cust
using(customer_id)
group by 1,2
order by  total_returns desc
)

select *,
case when total_returns >= 5 then "Returning" else "New" end as "return status"
from cte

```
---
![image](https://github.com/user-attachments/assets/1ded3431-6191-485b-b61c-a16e1b1be855)
---
ðŸŸ¢.Q.17.Revenue by Shipping Provider Calculate the total revenue handled by each shipping provider.
Challenge: Include the total number of orders(units) handled and the average delivery time for each provider
```sql
SELECT 
    shpng.shipping_providers,
    SUM(ord_itm.quantity) AS total_orders,
    ROUND(SUM(ord_itm.quantity * ord_itm.price_per_unit), 2) AS total_revenue,
    AVG(DATEDIFF(shpng.shipping_date, ord.order_date)) AS avg_delivery_time
FROM order_items AS ord_itm
JOIN orders AS ord USING(order_id)
JOIN shippings AS shpng USING(order_id)
GROUP BY shpng.shipping_providers;
```
---
![image](https://github.com/user-attachments/assets/ed79f0b0-0338-45ca-be54-7b24e3ec2ada)
---
ðŸŸ¢.Q.18. Top 5 Customers by Orders in Each State
Identify the top 5 customers with the highest number of orders (units)for each state.
Challenge: Include the number of orders and total sales for each customer.
```sql
with customer_ord_information as (
select cust.state,cust.first_name,cust.last_name
,sum(ord_itm.quantity) as total_order_units,
dense_rank()over(partition by cust.state order by sum(ord_itm.quantity) desc) as rnk
from orders as ord
join order_items as ord_itm
using(order_id)
join customers as cust
using(customer_id)
group by 1,2,3
)

select * from customer_ord_information
where rnk <= 5
```
![image](https://github.com/user-attachments/assets/c0c061a6-152d-49b6-b5cc-c2664d180d9a)
---
ðŸŸ¢.Q.19.Top 10 product with highest decreasing revenue ratio compare to last year(2022) and current_year(2023) 
Challenge: Return product_id, product_name, category_name, 2022 revenue and 2023 revenue decrease ratio at end Round the result Note: Decrease ratio = cr-ls/ls* 100 (cs = current_year ls=last_year)
```sql
with cte as (
select p.product_id,p.product_name,cat.category_name,
round(sum(case when year(o.order_date) = 2022 then (ord_itm.quantity*ord_itm.price_per_unit) else 0 end),2) as "total_rnv_two_two",
round(sum(case when year(o.order_date) = 2023 then (ord_itm.quantity*ord_itm.price_per_unit) else 0 end),2) as "total_rnv_two_three"
-- round(sum(ord_itm.quantity*ord_itm.price_per_unit),2)as total_rvn from 
from order_items as ord_itm
join orders as o
using(order_id)
join products as p
using(product_id)
join category as cat
using(category_id)
where year(o.order_date) in (2022,2023)
group by 1,2,3
)
select *,round(((total_rnv_two_three - total_rnv_two_two)/total_rnv_two_two)*100,2) 
as change_yoy from cte
where total_rnv_two_three < total_rnv_two_two
order by change_yoy
limit 10
-- select * from cte
```
---
![image](https://github.com/user-attachments/assets/442b22cf-0a17-4864-b35d-5f9871867c52)

---

ðŸŸ¢.Q.20.Final Task: Stored Procedure Create a stored procedure that, when a product is sold, performs the following actions: 
Inserts a new sales record into the orders and order_items tables. Updates the inventory table to reduce the stock based on the product and quantity purchased. 
The procedure should ensure that the stock is adjusted immediately after recording the sale.
Note :-  input values from the user is  name of the product,qty,cust_id,seller_id.
```sql
	DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `inventory_update`(
    IN in_product_name TEXT,
    IN in_quantity INT,
    IN in_cust_id INT,
    IN in_seller_id INT
)
BEGIN
    -- ==========================================================
    -- variable declarations
    -- ==========================================================
    DECLARE product_flag INT DEFAULT 0;
    DECLARE inventory_flag INT DEFAULT 0;
    DECLARE max_order_id INT DEFAULT 0;
    DECLARE prd_price FLOAT DEFAULT 0;
    DECLARE prd_id_check INT DEFAULT 0;

    -- ==========================================================
    -- checking the Product info
    -- ==========================================================
    SELECT 1, product_id, price
    INTO product_flag, prd_id_check, prd_price
    FROM products
    WHERE product_name = in_product_name
    LIMIT 1;

    -- ==========================================================
    -- checking the inventory info
    -- ==========================================================
    SELECT 1
    INTO inventory_flag
    FROM inventory
    WHERE inventory.product_id = prd_id_check
      AND inventory.stock >= in_quantity
    LIMIT 1;

    -- ==========================================================
    -- get the max order_id for new order entry into orders table
    -- ==========================================================
    SELECT IFNULL(MAX(order_id), 0)
    INTO max_order_id
    FROM order_items;

    -- ==========================================================
    -- check the product and inventory qty and update the info
    -- ==========================================================
    IF inventory_flag > 0 AND product_flag > 0 THEN
        -- order_items table updates
        INSERT INTO order_items(order_item_id, order_id, product_id, quantity, price_per_unit)
        VALUES (max_order_id+1, max_order_id+1, prd_id_check, in_quantity, ROUND(prd_price,2));

        -- orders table updates
        INSERT INTO orders (order_id, order_date, customer_id, seller_id, order_status)
        VALUES (max_order_id+1, CURRENT_DATE(), in_cust_id, in_seller_id, 'Inprogress');

        -- update the inventory
        UPDATE inventory
        SET inventory.stock = (stock - in_quantity),
            inventory.last_stock_date = CURRENT_DATE()
        WHERE inventory.product_id = prd_id_check;

        -- success message
        SELECT 'Thanks for purchasing the product!' AS flag, in_product_name AS product;
    ELSE
        -- failure message
        SELECT 'Product Quantity is out of stock!' AS flag, in_quantity AS requested_qty;
    END IF;
END$$

DELIMITER ;

	#select "yes",in_product_name;
	#
	END
```
